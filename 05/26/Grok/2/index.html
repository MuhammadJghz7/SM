<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدیریت دروس کارشناسی فیزیک</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/main.min.css">
    <style>
        :root {
            --bg-color: #f4f4f4;
            --text-color: #333;
            --card-bg: #fff;
            --primary-color: #007bff;
        }
        .dark-mode {
            --bg-color: #222;
            --text-color: #f4f4f4;
            --card-bg: #333;
        }
        body { background: var(--bg-color); color: var(--text-color); font-family: 'Vazirmatn', sans-serif; padding: 20px; transition: all 0.3s ease; }
        .section { display: none; }
        .active { display: block; }
        .loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .spinner { border: 16px solid #f3f3f3; border-top: 16px solid var(--primary-color); border-radius: 50%; width: 120px; height: 120px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .tile { border: none; padding: 15px; margin: 10px; border-radius: 10px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); background: var(--card-bg); transition: transform 0.3s, opacity 0.3s; opacity: 0; }
        .tile.show { opacity: 1; }
        .tile:hover { transform: translateY(-5px); }
        .general { background: #d4edda; } /* سبز روشن */
        .base { background: #d1ecf1; } /* آبی روشن */
        .main { background: #f8d7da; } /* قرمز روشن */
        .optional { background: #fff3cd; } /* زرد روشن */
        .tile i { font-size: 2rem; margin-bottom: 10px; color: var(--primary-color); }
        .courses-container { display: flex; flex-wrap: wrap; justify-content: center; }
        table { margin-top: 20px; }
        th, td { text-align: center; vertical-align: middle; }
        .schedule-block { background: #e2e3e5; padding: 5px; border-radius: 5px; font-size: 0.9rem; }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 1500; }
        .progress-bar { background-color: #28a745; transition: width 0.5s ease; }
        #calendar { max-width: 900px; margin: 20px auto; }
        @media (max-width: 768px) {
            .tile { width: 100%; margin: 10px 0; }
            table { font-size: 0.8rem; }
        }
        @font-face { font-family: 'Vazirmatn'; src: url('https://cdn.fontcdn.ir/Font/Persian/Vazirmatn/Vazirmatn-Regular.woff2') format('woff2'); }
    </style>
</head>
<body>
    <div id="loading" class="loading"><div class="spinner"></div></div>
    <div class="toast-container"></div>
    <div class="container">
        <div class="d-flex justify-content-between mb-4">
            <div>
                <label class="form-check-label">
                    <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()"> حالت تاریک
                </label>
            </div>
            <div>
                <select class="form-select" id="languageToggle" onchange="changeLanguage()">
                    <option value="fa">فارسی</option><option value="en">English</option>
                </select>
            </div>
        </div>
        <div id="dashboard" class="active">
            <h1 class="text-center mb-4">مدیریت دروس کارشناسی فیزیک</h1>
            <div class="row justify-content-center">
                <div class="col-md-3"><button class="btn btn-primary w-100 mb-2" onclick="showSection('registerCourses')"><i class="fas fa-book"></i> ثبت دروس</button></div>
                <div class="col-md-3"><button class="btn btn-info w-100 mb-2" onclick="showSection('termsList')"><i class="fas fa-list"></i> اطلاعات ترم‌ها</button></div>
                <div class="col-md-3"><button class="btn btn-success w-100 mb-2" onclick="showSection('reports')"><i class="fas fa-chart-bar"></i> گزارش‌های تحلیلی</button></div>
                <div class="col-md-3"><button class="btn btn-warning w-100 mb-2" onclick="showSection('calendar')"><i class="fas fa-calendar-alt"></i> تقویم امتحانات</button></div>
            </div>
            <div class="progress mt-4">
                <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
            </div>
            <p class="text-center mt-2">واحدهای پاس‌شده: <span id="passedUnits">0</span> / ۱۴۰</p>
            <p class="text-center">معدل کل: <span id="overallGPA" class="fw-bold">0</span></p>
            <div class="row justify-content-center mt-3">
                <div class="col-md-4"><button class="btn btn-secondary w-100" onclick="exportData()"><i class="fas fa-download"></i> دانلود داده‌ها</button></div>
                <div class="col-md-4"><input type="file" class="form-control" id="importFile" accept=".json" onchange="importData()"></div>
            </div>
        </div>
        <div id="registerCourses" class="section">
            <h2 class="text-center mb-4">ثبت دروس</h2>
            <input type="text" class="form-control mb-3" id="courseSearch" placeholder="جستجوی درس (نام، شماره، نوع)" oninput="searchCourses()">
            <form id="courseForm" class="row g-3">
                <div class="col-md-6"><input type="text" class="form-control" id="courseId" placeholder="شماره درس" required></div>
                <div class="col-md-6"><input type="text" class="form-control" id="courseName" placeholder="نام درس" required></div>
                <div class="col-md-4"><input type="number" class="form-control" id="theoretical" placeholder="واحد تئوری" min="0" required></div>
                <div class="col-md-4"><input type="number" class="form-control" id="practical" placeholder="واحد عملی" min="0" required></div>
                <div class="col-md-4">
                    <select class="form-select" id="type">
                        <option>عمومی</option><option>پایه</option><option>اصلی</option><option>اختیاری</option>
                    </select>
                </div>
                <div class="col-md-6"><input type="text" class="form-control" id="prerequisites" placeholder="پیش‌نیازها (شماره‌ها با کاما)"></div>
                <div class="col-md-6"><input type="text" class="form-control" id="corequisites" placeholder="هم‌نیازها (شماره‌ها با کاما)"></div>
                <div class="col-12"><button type="submit" class="btn btn-primary w-100"><i class="fas fa-plus"></i> ثبت درس</button></div>
            </form>
            <div id="coursesTiles" class="courses-container mt-4"></div>
        </div>
        <div id="termsList" class="section">
            <h2 class="text-center mb-4">فهرست ترم‌ها</h2>
            <ul id="termsUl" class="list-group"></ul>
        </div>
        <div id="termDetail" class="section">
            <h2 class="text-center mb-4">جزئیات ترم <span id="termId"></span></h2>
            <button class="btn btn-primary mb-3" onclick="showAddCourseModal()"><i class="fas fa-plus-circle"></i> اضافه کردن درس</button>
            <div id="termCourses" class="list-group mb-4"></div>
            <h3 class="mb-3">برنامه هفتگی</h3>
            <table class="table table-bordered" id="weeklySchedule">
                <thead><tr><th>ساعت/روز</th><th>شنبه</th><th>یکشنبه</th><th>دوشنبه</th><th>سه‌شنبه</th><th>چهارشنبه</th></tr></thead>
                <tbody></tbody>
            </table>
            <p class="text-center">معدل ترم: <span id="termGPA" class="fw-bold">0</span></p>
        </div>
        <div id="calendar" class="section">
            <h2 class="text-center mb-4">تقویم امتحانات</h2>
            <div id="examCalendar"></div>
        </div>
        <div id="reports" class="section">
            <h2 class="text-center mb-4">گزارش‌های تحلیلی</h2>
            <canvas id="unitsChart" width="400" height="200" class="mb-4"></canvas>
            <canvas id="gpaChart" width="400" height="200" class="mb-4"></canvas>
            <canvas id="gradesChart" width="400" height="200"></canvas>
        </div>
    </div>

    <!-- Modal برای اضافه کردن درس به ترم -->
    <div class="modal fade" id="addCourseModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">اضافه کردن درس به ترم</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addCourseForm">
                        <div class="mb-3">
                            <label>درس:</label>
                            <select id="selectCourse" class="form-select" onchange="generateSessionFields()"></select>
                        </div>
                        <div class="mb-3" id="prereqChecklist"></div>
                        <div class="mb-3"><label>گروه درسی:</label><input type="text" class="form-control" id="group" required></div>
                        <div class="mb-3"><label>زمان امتحان (مثال: ۱۴۰۴/۰۴/۱۵ ۱۰:۰۰):</label><input type="text" class="form-control" id="examTime" required pattern="\d{4}/\d{2}/\d{2} \d{2}:\d{2}"></div>
                        <div id="sessionsContainer" class="mb-3"></div>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-save"></i> اضافه کردن</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/main.min.js"></script>
    <script>
        // ترم‌های پیش‌فرض
        const defaultTerms = ['۴۰۲۱', '۴۰۲۲', '۴۰۲۳', '۴۰۳۱', '۴۰۳۲', '۴۰۳۳', '۴۰۴۱', '۴۰۴۲', '۴۰۴۳', '۴۰۵۱', '۴۰۵۲', '۴۰۵۳', '۴۰۶۱', '۴۰۶۲', '۴۰۶۳'];

        // دروس پیش‌فرض کارشناسی فیزیک مطابق سرفصل ۱۳۹۴ وزارت علوم + دروس عمومی
        const defaultCourses = [
            // دروس عمومی (22 واحد)
            { id: '001', name: 'اندیشه اسلامی ۱ (مبدا و معاد)', theoretical: 2, practical: 0, total: 2, prerequisites: '', corequisites: '', type: 'عمومی' },
            { id: '002', name: 'اندیشه اسلامی ۲ (نبوت و امامت)', theoretical: 2, practical: 0, total: 2, prerequisites: '', corequisites: '', type: 'عمومی' },
            { id: '003', name: 'انسان در اسلام', theoretical: 2, practical: 0, total: 2, prerequisites: '', corequisites: '', type: 'عمومی' },
            { id: '004', name: 'حقوق اجتماعی و سیاسی در اسلام', theoretical: 2, practical: 0, total: 2, prerequisites: '', corequisites: '', type: 'عمومی' },
            { id: '005', name: 'اخلاق اسلامی (مبانی و مفاهیم)', theoretical: 2, practical: 0, total: 2, prerequisites: '', corequisites: '', type: 'عمومی' },
            { id: '006', name: 'آیین زندگی (اخلاق کاربردی)', theoretical: 2, practical: 0, total: 2, prerequisites: '', corequisites: '', type: 'عمومی' },
            { id: '007', name: 'عرفان عملی در اسلام', theoretical: 2, practical: 0, total: 2, prerequisites: '', corequisites: '', type: 'عمومی' },
            { id: '008', name: 'اخلاق مهندسی', theoretical: 2, practical: 0, total: 2, prerequisites: '', corequisites: '', type: 'عمومی' },
            { id: '009', name: 'انقلاب اسلامی ایران', theoretical: 2, practical: 0, total: 2, prerequisites: '', corequisites: '', type: 'عمومی' },
            { id: '010', name: 'آشنایی با قانون اساسی جمهوری اسلامی ایران', theoretical: 2, practical: 0, total: 2, prerequisites: '', corequisites: '', type: 'عمومی' },
            { id: '011', name: 'اندیشه سیاسی امام خمینی (ره)', theoretical: 2, practical: 0, total: 2, prerequisites: '', corequisites: '', type: 'عمومی' },
            { id: '012', name: 'تاریخ فرهنگ و تمدن اسلامی', theoretical: 2, practical: 0, total: 2, prerequisites: '', corequisites: '', type: 'عمومی' },
            { id: '013', name: 'تاریخ تحلیلی صدر اسلام', theoretical: 2, practical: 0, total: 2, prerequisites: '', corequisites: '', type: 'عمومی' },
            { id: '014', name: 'تاریخ امامت', theoretical: 2, practical: 0, total: 2, prerequisites: '', corequisites: '', type: 'عمومی' },
            { id: '015', name: 'تفسیر موضوعی قرآن', theoretical: 2, practical: 0, total: 2, prerequisites: '', corequisites: '', type: 'عمومی' },
            { id: '016', name: 'تفسیر موضوعی نهج‌البلاغه', theoretical: 2, practical: 0, total: 2, prerequisites: '', corequisites: '', type: 'عمومی' },
            { id: '017', name: 'فارسی عمومی', theoretical: 3, practical: 0, total: 3, prerequisites: '', corequisites: '', type: 'عمومی' },
            { id: '018', name: 'زبان انگلیسی عمومی', theoretical: 3, practical: 0, total: 3, prerequisites: '', corequisites: '', type: 'عمومی' },
            { id: '019', name: 'تربیت بدنی ۱', theoretical: 0, practical: 1, total: 1, prerequisites: '', corequisites: '', type: 'عمومی' },
            { id: '020', name: 'تربیت بدنی ۲', theoretical: 0, practical: 1, total: 1, prerequisites: '', corequisites: '', type: 'عمومی' },
            { id: '021', name: 'دانش خانواده و جمعیت', theoretical: 2, practical: 0, total: 2, prerequisites: '', corequisites: '', type: 'عمومی' },

            // دروس پایه (35 واحد)
            { id: '101', name: 'ریاضی عمومی ۱', theoretical: 3, practical: 0, total: 3, prerequisites: '', corequisites: '', type: 'پایه' },
            { id: '102', name: 'ریاضی عمومی ۲', theoretical: 3, practical: 0, total: 3, prerequisites: '101', corequisites: '', type: 'پایه' },
            { id: '103', name: 'فیزیک عمومی ۱', theoretical: 3, practical: 0, total: 3, prerequisites: '', corequisites: '', type: 'پایه' },
            { id: '104', name: 'فیزیک عمومی ۲', theoretical: 3, practical: 0, total: 3, prerequisites: '103', corequisites: '', type: 'پایه' },
            { id: '105', name: 'فیزیک عمومی ۳', theoretical: 3, practical: 0, total: 3, prerequisites: '104', corequisites: '', type: 'پایه' },
            { id: '106', name: 'فیزیک عمومی ۴', theoretical: 3, practical: 0, total: 3, prerequisites: '105', corequisites: '', type: 'پایه' },
            { id: '107', name: 'آزمایشگاه فیزیک ۱', theoretical: 0, practical: 1, total: 1, prerequisites: '', corequisites: '103', type: 'پایه' },
            { id: '108', name: 'آزمایشگاه فیزیک ۲', theoretical: 0, practical: 1, total: 1, prerequisites: '', corequisites: '104', type: 'پایه' },
            { id: '109', name: 'آزمایشگاه فیزیک ۳', theoretical: 0, practical: 1, total: 1, prerequisites: '', corequisites: '105', type: 'پایه' },
            { id: '110', name: 'شیمی عمومی', theoretical: 3, practical: 0, total: 3, prerequisites: '', corequisites: '', type: 'پایه' },
            { id: '111', name: 'آزمایشگاه شیمی عمومی', theoretical: 0, practical: 1, total: 1, prerequisites: '', corequisites: '110', type: 'پایه' },
            { id: '112', name: 'معادلات دیفرانسیل', theoretical: 3, practical: 0, total: 3, prerequisites: '102', corequisites: '', type: 'پایه' },
            { id: '113', name: 'ریاضی فیزیک ۱', theoretical: 3, practical: 0, total: 3, prerequisites: '102', corequisites: '', type: 'پایه' },
            { id: '114', name: 'ریاضی فیزیک ۲', theoretical: 3, practical: 0, total: 3, prerequisites: '113', corequisites: '', type: 'پایه' },
            { id: '115', name: 'مبانی کامپیوتر و برنامه‌نویسی', theoretical: 2, practical: 1, total: 3, prerequisites: '', corequisites: '', type: 'پایه' },

            // دروس اصلی (70 واحد)
            { id: '201', name: 'مکانیک کلاسیک ۱', theoretical: 3, practical: 0, total: 3, prerequisites: '104', corequisites: '112', type: 'اصلی' },
            { id: '202', name: 'مکانیک کلاسیک ۲', theoretical: 3, practical: 0, total: 3, prerequisites: '201', corequisites: '', type: 'اصلی' },
            { id: '203', name: 'الکترومغناطیس ۱', theoretical: 3, practical: 0, total: 3, prerequisites: '105', corequisites: '113', type: 'اصلی' },
            { id: '204', name: 'الکترومغناطیس ۲', theoretical: 3, practical: 0, total: 3, prerequisites: '203', corequisites: '', type: 'اصلی' },
            { id: '205', name: 'ترمودینامیک و مکانیک آماری', theoretical: 3, practical: 0, total: 3, prerequisites: '104', corequisites: '', type: 'اصلی' },
            { id: '206', name: 'فیزیک جدید', theoretical: 3, practical: 0, total: 3, prerequisites: '106', corequisites: '', type: 'اصلی' },
            { id: '207', name: 'مکانیک کوانتومی ۱', theoretical: 3, practical: 0, total: 3, prerequisites: '206', corequisites: '114', type: 'اصلی' },
            { id: '208', name: 'مکانیک کوانتومی ۲', theoretical: 3, practical: 0, total: 3, prerequisites: '207', corequisites: '', type: 'اصلی' },
            { id: '209', name: 'آزمایشگاه فیزیک مدرن', theoretical: 0, practical: 2, total: 2, prerequisites: '206', corequisites: '', type: 'اصلی' },
            { id: '210', name: 'آزمایشگاه فیزیک پیشرفته ۱', theoretical: 0, practical: 2, total: 2, prerequisites: '109', corequisites: '', type: 'اصلی' },
            { id: '211', name: 'آزمایشگاه فیزیک پیشرفته ۲', theoretical: 0, practical: 2, total: 2, prerequisites: '210', corequisites: '', type: 'اصلی' },
            { id: '212', name: 'فیزیک محاسباتی', theoretical: 2, practical: 1, total: 3, prerequisites: '115', corequisites: '', type: 'اصلی' },
            { id: '213', name: 'پروژه', theoretical: 0, practical: 3, total: 3, prerequisites: '', corequisites: '', type: 'اصلی' },
            // ... (اضافه کردن بقیه دروس اصلی مانند فیزیک هسته‌ای مقدماتی, فیزیک حالت جامد, اپتیک, etc. بر اساس سرفصل کامل)

            // دروس اختیاری (حدود 9 واحد)
            { id: '301', name: 'فیزیک هسته‌ای ۱', theoretical: 3, practical: 0, total: 3, prerequisites: '207', corequisites: '', type: 'اختیاری' },
            { id: '302', name: 'فیزیک حالت جامد ۱', theoretical: 3, practical: 0, total: 3, prerequisites: '207', corequisites: '', type: 'اختیاری' },
            { id: '303', name: 'لیزر', theoretical: 3, practical: 0, total: 3, prerequisites: '207', corequisites: '', type: 'اختیاری' },
            { id: '304', name: 'فیزیک ذرات بنیادی', theoretical: 3, practical: 0, total: 3, prerequisites: '207', corequisites: '', type: 'اختیاری' },
            // ... (اضافه کردن بقیه اختیاری مانند نجوم, هواشناسی, etc.)
        ];


        // ترجمه‌ها
        const translations = {
            fa: {
                dashboard: 'مدیریت دروس دانشجویی',
                registerCourses: 'ثبت دروس',
                termsList: 'اطلاعات ترم‌ها',
                reports: 'گزارش‌های تحلیلی',
                calendar: 'تقویم امتحانات',
                overallGPA: 'معدل کل',
                passedUnits: 'واحدهای پاس‌شده',
                exportData: 'دانلود داده‌ها',
                importData: 'آپلود داده‌ها',
                courseSearch: 'جستجوی درس (نام، شماره، نوع)',
                courseId: 'شماره درس',
                courseName: 'نام درس',
                theoretical: 'واحد تئوری',
                practical: 'واحد عملی',
                type: 'نوع درس',
                prerequisites: 'پیش‌نیازها (شماره‌ها با کاما)',
                corequisites: 'هم‌نیازها (شماره‌ها با کاما)',
                addCourse: 'اضافه کردن درس',
                termGPA: 'معدل ترم',
                darkMode: 'حالت تاریک',
                language: 'زبان',
                sessions: 'جلسات',
                examTime: 'زمان امتحان',
                group: 'گروه درسی',
                location: 'محل برگزاری',
                notes: 'یادداشت',
                prereqPassed: 'پاس شده',
                prereqNotPassed: 'پاس نشده',
                add: 'اضافه کردن',
                edit: 'ویرایش',
                delete: 'حذف',
                save: 'ذخیره'
            },
            en: {
                dashboard: 'Student Course Management',
                registerCourses: 'Register Courses',
                termsList: 'Terms Information',
                reports: 'Analytical Reports',
                calendar: 'Exam Calendar',
                overallGPA: 'Overall GPA',
                passedUnits: 'Passed Units',
                exportData: 'Download Data',
                importData: 'Upload Data',
                courseSearch: 'Search Courses (name, ID, type)',
                courseId: 'Course ID',
                courseName: 'Course Name',
                theoretical: 'Theoretical Units',
                practical: 'Practical Units',
                type: 'Course Type',
                prerequisites: 'Prerequisites (IDs separated by commas)',
                corequisites: 'Corequisites (IDs separated by commas)',
                addCourse: 'Add Course',
                termGPA: 'Term GPA',
                darkMode: 'Dark Mode',
                language: 'Language',
                sessions: 'Sessions',
                examTime: 'Exam Time',
                group: 'Course Group',
                location: 'Location',
                notes: 'Notes',
                prereqPassed: 'Passed',
                prereqNotPassed: 'Not Passed',
                add: 'Add',
                edit: 'Edit',
                delete: 'Delete',
                save: 'Save'
            }
        };

        let courses = JSON.parse(localStorage.getItem('courses')) || defaultCourses;
        let terms = JSON.parse(localStorage.getItem('terms')) || defaultTerms.map(t => ({ id: t, courses: [], totalUnits: 0, gpa: 0 }));
        let passedCourses = JSON.parse(localStorage.getItem('passedCourses')) || [];
        let currentLanguage = localStorage.getItem('language') || 'fa';

        const days = ['شنبه', 'یکشنبه', 'دوشنبه', 'سه‌شنبه', 'چهارشنبه'];
        const hours = ['۸:۰۰ تا ۱۰:۰۰', '۱۰:۰۰ تا ۱۲:۰۰', '۱۳:۰۰ تا ۱۵:۰۰', '۱۵:۰۰ تا ۱۷:۰۰', '۱۷:۰۰ تا ۱۹:۰۰']; // ساعات مجاز
        const addCourseModal = new bootstrap.Modal(document.getElementById('addCourseModal'));
        let currentTermId = null;

        function showLoading(show) { document.getElementById('loading').style.display = show ? 'flex' : 'none'; }

        function saveData() {
            showLoading(true);
            localStorage.setItem('courses', JSON.stringify(courses));
            localStorage.setItem('terms', JSON.stringify(terms));
            localStorage.setItem('passedCourses', JSON.stringify(passedCourses));
            localStorage.setItem('language', currentLanguage);
            setTimeout(() => showLoading(false), 500);
        }

        function showToast(message) {
            const toastContainer = document.querySelector('.toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `<div class="toast-body">${message}</div>`;
            toastContainer.appendChild(toast);
            new bootstrap.Toast(toast).show();
            setTimeout(() => toast.remove(), 3000);
        }

        function showSection(section) {
            document.querySelectorAll('.section, #dashboard').forEach(el => el.classList.remove('active'));
            document.getElementById(section).classList.add('active');
            if (section === 'registerCourses') renderCoursesTiles();
            if (section === 'termsList') renderTermsList();
            if (section === 'reports') renderReports();
            if (section === 'calendar') renderCalendar();
        }

        function changeLanguage() {
            currentLanguage = document.getElementById('languageToggle').value;
            updateUIText();
            renderCoursesTiles();
            renderTermsList();
            if (currentTermId) showTermDetail(currentTermId);
            saveData();
        }

        function updateUIText() {
            document.querySelector('h1').textContent = translations[currentLanguage].dashboard;
            document.querySelector('#registerCourses h2').textContent = translations[currentLanguage].registerCourses;
            document.querySelector('#termsList h2').textContent = translations[currentLanguage].termsList;
            document.querySelector('#calendar h2').textContent = translations[currentLanguage].calendar;
            document.querySelector('#reports h2').textContent = translations[currentLanguage].reports;
            document.querySelector('#overallGPA').previousElementSibling.textContent = translations[currentLanguage].overallGPA + ': ';
            document.querySelector('#passedUnits').previousElementSibling.textContent = translations[currentLanguage].passedUnits + ': ';
            document.querySelector('#courseSearch').placeholder = translations[currentLanguage].courseSearch;
            document.querySelector('#courseId').placeholder = translations[currentLanguage].courseId;
            document.querySelector('#courseName').placeholder = translations[currentLanguage].courseName;
            document.querySelector('#theoretical').placeholder = translations[currentLanguage].theoretical;
            document.querySelector('#practical').placeholder = translations[currentLanguage].practical;
            document.querySelector('#prerequisites').placeholder = translations[currentLanguage].prerequisites;
            document.querySelector('#corequisites').placeholder = translations[currentLanguage].corequisites;
            document.querySelector('#courseForm button').innerHTML = `<i class="fas fa-plus"></i> ${translations[currentLanguage].add}`;
            document.querySelector('#darkModeToggle').nextElementSibling.textContent = translations[currentLanguage].darkMode;
            document.querySelector('#languageToggle').previousElementSibling.textContent = translations[currentLanguage].language;
        }

        // ثبت درس جدید
        document.getElementById('courseForm').addEventListener('submit', e => {
            e.preventDefault();
            const newCourse = {
                id: document.getElementById('courseId').value,
                name: document.getElementById('courseName').value,
                theoretical: parseInt(document.getElementById('theoretical').value),
                practical: parseInt(document.getElementById('practical').value),
                total: parseInt(document.getElementById('theoretical').value) + parseInt(document.getElementById('practical').value),
                prerequisites: document.getElementById('prerequisites').value,
                corequisites: document.getElementById('corequisites').value,
                type: document.getElementById('type').value
            };
            if (courses.some(c => c.id === newCourse.id)) {
                showToast('شماره درس تکراری است!');
                return;
            }
            if (passedCourses.includes(newCourse.id)) {
                showToast(translations[currentLanguage].courseId + ' قبلاً پاس شده!');
                return;
            }
            courses.push(newCourse);
            saveData();
            renderCoursesTiles();
            e.target.reset();
        });

        // جستجوی دروس
        function searchCourses() {
            const query = document.getElementById('courseSearch').value.toLowerCase();
            renderCoursesTiles(query);
        }

        // نمایش تایل‌ها با انیمیشن
        function renderCoursesTiles(query = '') {
            const tilesDiv = document.getElementById('coursesTiles');
            tilesDiv.innerHTML = '';
            const typeOrder = ['عمومی', 'پایه', 'اختیاری', 'اصلی'];
            const filteredCourses = courses.filter(c => 
                c.name.toLowerCase().includes(query) || 
                c.id.includes(query) || 
                c.type.toLowerCase().includes(query)
            ).sort((a, b) => {
                const typeDiff = typeOrder.indexOf(a.type) - typeOrder.indexOf(b.type);
                if (typeDiff !== 0) return typeDiff;
                return a.id.localeCompare(b.id);
            });
            filteredCourses.forEach((course, index) => {
                const tile = document.createElement('div');
                tile.className = `tile col-md-3 ${course.type === 'عمومی' ? 'general' : course.type === 'پایه' ? 'base' : course.type === 'اصلی' ? 'main' : 'optional'}`;
                tile.innerHTML = `
                    <i class="fas fa-book"></i>
                    <h5>${course.name} (${course.id})</h5>
                    <p>${translations[currentLanguage].theoretical}: ${course.theoretical} | ${translations[currentLanguage].practical}: ${course.practical} | ${translations[currentLanguage].total}: ${course.total}</p>
                    <p>${translations[currentLanguage].type}: ${course.type}</p>
                    <button class="btn btn-sm btn-warning" onclick="editCourse('${course.id}')"><i class="fas fa-edit"></i> ${translations[currentLanguage].edit}</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteCourse('${course.id}')"><i class="fas fa-trash"></i> ${translations[currentLanguage].delete}</button>
                `;
                tilesDiv.appendChild(tile);
                setTimeout(() => tile.classList.add('show'), index * 100); // انیمیشن fade-in
            });
        }

        // فهرست ترم‌ها
        function renderTermsList() {
            const ul = document.getElementById('termsUl');
            ul.innerHTML = '';
            terms.forEach(term => {
                const li = document.createElement('li');
                li.className = 'list-group-item list-group-item-action';
                li.innerHTML = `${term.id} - ${translations[currentLanguage].passedUnits}: ${term.totalUnits}`;
                li.onclick = () => showTermDetail(term.id);
                ul.appendChild(li);
            });
        }

        // جزئیات ترم
        function showTermDetail(termId) {
            showSection('termDetail');
            currentTermId = termId;
            document.getElementById('termId').textContent = termId;
            const term = terms.find(t => t.id === termId);
            renderTermCourses(term);
            renderWeeklySchedule(term);
            calculateTermGPA(term);
        }

        function renderTermCourses(term) {
            const div = document.getElementById('termCourses');
            div.innerHTML = '';
            term.courses.forEach((c, index) => {
                const item = document.createElement('div');
                item.className = 'list-group-item';
                item.innerHTML = `
                    <h5>${c.name} (${c.id}) - ${translations[currentLanguage].group}: ${c.group}</h5>
                    <p>${translations[currentLanguage].sessions}: ${c.sessions.map(s => `${s.day} ${s.time} (${s.location}) ${s.isAlternate ? '(زوج/فرد)' : ''}`).join(', ')}</p>
                    <p>${translations[currentLanguage].examTime}: ${c.examTime}</p>
                    <label>${translations[currentLanguage].grade}: </label><input type="number" min="0" max="20" value="${c.grade || ''}" onchange="updateGrade(${index}, this.value, '${currentTermId}')" class="form-control d-inline-block w-auto">
                    <p><label>${translations[currentLanguage].notes}: </label><textarea class="form-control" onchange="updateNotes(${index}, this.value, '${currentTermId}')">${c.notes || ''}</textarea></p>
                `;
                div.appendChild(item);
            });
        }

        function renderWeeklySchedule(term) {
            const tbody = document.getElementById('weeklySchedule').querySelector('tbody');
            tbody.innerHTML = '';
            hours.forEach(hour => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${hour}</td>`;
                days.forEach(day => {
                    let cellContent = '';
                    term.courses.forEach(c => {
                        c.sessions.forEach(s => {
                            if (s.day === day && s.time === hour) {
                                cellContent = `<div class="schedule-block">${c.name}</div>`;
                            }
                        });
                    });
                    tr.innerHTML += `<td>${cellContent}</td>`;
                });
                tbody.appendChild(tr);
            });
        }

        function calculateTermGPA(term) {
            let totalWeighted = 0, totalUnits = 0;
            term.courses.forEach(c => {
                if (c.grade >= 10) {
                    totalWeighted += c.grade * c.total;
                    totalUnits += c.total;
                }
            });
            term.gpa = totalUnits ? (totalWeighted / totalUnits).toFixed(2) : 0;
            term.totalUnits = term.courses.reduce((sum, c) => sum + c.total, 0);
            document.getElementById('termGPA').textContent = term.gpa;
            saveData();
            calculateOverallGPA();
            updateProgress();
        }

        function updateGrade(index, value, termId) {
            const term = terms.find(t => t.id === termId);
            term.courses[index].grade = parseFloat(value);
            if (term.courses[index].grade >= 10 && !passedCourses.includes(term.courses[index].id)) {
                passedCourses.push(term.courses[index].id);
                showToast(`${term.courses[index].name} پاس شد!`);
            }
            calculateTermGPA(term);
        }

        function updateNotes(index, value, termId) {
            const term = terms.find(t => t.id === termId);
            term.courses[index].notes = value;
            saveData();
        }

        function showAddCourseModal() {
            const select = document.getElementById('selectCourse');
            select.innerHTML = '';
            courses.forEach(c => {
                if (!passedCourses.includes(c.id)) {
                    const option = document.createElement('option');
                    option.value = c.id;
                    option.textContent = `${c.name} (${c.id})`;
                    select.appendChild(option);
                }
            });
            document.getElementById('sessionsContainer').innerHTML = '';
            generateSessionFields();
            renderPrereqChecklist();
            addCourseModal.show();
        }

        function renderPrereqChecklist() {
            const courseId = document.getElementById('selectCourse').value;
            const course = courses.find(c => c.id === courseId);
            const checklist = document.getElementById('prereqChecklist');
            checklist.innerHTML = '<h6>وضعیت پیش‌نیازها:</h6>';
            const prereqs = course.prerequisites.split(',').filter(p => p.trim());
            if (!prereqs.length) {
                checklist.innerHTML += '<p>بدون پیش‌نیاز</p>';
                return;
            }
            prereqs.forEach(p => {
                const status = passedCourses.includes(p.trim()) ? translations[currentLanguage].prereqPassed : translations[currentLanguage].prereqNotPassed;
                const badge = `<span class="badge ${passedCourses.includes(p.trim()) ? 'bg-success' : 'bg-danger'}">${status}: ${p}</span>`;
                checklist.innerHTML += badge + ' ';
            });
        }

        function generateSessionFields() {
            const courseId = document.getElementById('selectCourse').value;
            const course = courses.find(c => c.id === courseId);
            if (!course) return;
            const sessionsContainer = document.getElementById('sessionsContainer');
            sessionsContainer.innerHTML = `<h6>${translations[currentLanguage].sessions}:</h6>`;
            let sessionCount = course.practical + Math.floor(course.theoretical / 2) + (course.theoretical % 2);
            for (let i = 0; i < sessionCount; i++) {
                const div = document.createElement('div');
                div.className = 'row mb-2';
                div.innerHTML = `
                    <div class="col-3">
                        <select class="form-select" id="day${i}">
                            ${days.map(d => `<option>${d}</option>`).join('')}
                        </select>
                    </div>
                    <div class="col-3">
                        <select class="form-select" id="time${i}">
                            ${hours.map(h => `<option>${h}</option>`).join('')}
                        </select>
                    </div>
                    <div class="col-3"><input type="text" class="form-control" id="location${i}" placeholder="${translations[currentLanguage].location}" required></div>
                    <div class="col-3">
                        <select class="form-select" id="alternate${i}">
                            <option value="none">${translations[currentLanguage].fixed}</option>
                            <option value="even">${translations[currentLanguage].even}</option>
                            <option value="odd">${translations[currentLanguage].odd}</option>
                        </select>
                    </div>
                `;
                sessionsContainer.appendChild(div);
                if (course.theoretical % 2 === 1 && i === sessionCount - 1) {
                    document.getElementById(`alternate${i}`).value = 'even';
                }
            }
            renderPrereqChecklist();
        }

        document.getElementById('addCourseForm').addEventListener('submit', e => {
            e.preventDefault();
            const courseId = document.getElementById('selectCourse').value;
            const course = {...courses.find(c => c.id === courseId)};
            course.group = document.getElementById('group').value;
            course.examTime = document.getElementById('examTime').value;
            course.sessions = [];
            const sessionCount = course.practical + Math.floor(course.theoretical / 2) + (course.theoretical % 2);
            const term = terms.find(t => t.id === currentTermId);

            // چک تداخل امتحان
            if (term.courses.some(c => c.examTime === course.examTime)) {
                showToast('تداخل زمان امتحان!');
                return;
            }

            for (let i = 0; i < sessionCount; i++) {
                const day = document.getElementById(`day${i}`).value;
                const time = document.getElementById(`time${i}`).value;
                const location = document.getElementById(`location${i}`).value;
                const alternate = document.getElementById(`alternate${i}`).value;
                if (time === '10:00-12:00' && day === 'دوشنبه') {
                    showToast('ساعت ۱۰ تا ۱۲ دوشنبه‌ها برای فعالیت فرهنگی رزرو است!');
                    return;
                }
                if (term.courses.some(c => c.sessions.some(s => s.day === day && s.time === time))) {
                    showToast('تداخل زمانی کلاس!');
                    return;
                }
                course.sessions.push({ day, time, location, isAlternate: alternate !== 'none' ? alternate : null });
            }

            const prereqs = course.prerequisites.split(',').filter(p => p);
            for (let prereq of prereqs) {
                if (!passedCourses.includes(prereq.trim())) {
                    showToast(`پیش‌نیاز ${prereq} پاس نشده!`);
                    return;
                }
            }

            term.courses.push(course);
            addCourseModal.hide();
            renderTermCourses(term);
            renderWeeklySchedule(term);
            calculateTermGPA(term);
            showToast(`${course.name} به ترم اضافه شد.`);
            checkExamReminders();
        });

        function editCourse(id) {
            const course = courses.find(c => c.id === id);
            if (course) {
                document.getElementById('courseId').value = course.id;
                document.getElementById('courseName').value = course.name;
                document.getElementById('theoretical').value = course.theoretical;
                document.getElementById('practical').value = course.practical;
                document.getElementById('prerequisites').value = course.prerequisites;
                document.getElementById('corequisites').value = course.corequisites;
                document.getElementById('type').value = course.type;
                courses = courses.filter(c => c.id !== id);
            }
        }

        function deleteCourse(id) {
            if (confirm(translations[currentLanguage].deleteConfirm)) {
                courses = courses.filter(c => c.id !== id);
                saveData();
                renderCoursesTiles();
            }
        }

        function calculateOverallGPA() {
            let totalWeighted = 0, totalUnits = 0;
            terms.forEach(term => {
                term.courses.forEach(c => {
                    if (c.grade >= 10) {
                        totalWeighted += c.grade * c.total;
                        totalUnits += c.total;
                    }
                });
            });
            document.getElementById('overallGPA').textContent = totalUnits ? (totalWeighted / totalUnits).toFixed(2) : 0;
        }

        function updateProgress() {
            const totalUnits = 140;
            const passedUnits = terms.reduce((sum, term) => 
                sum + term.courses.reduce((s, c) => s + (c.grade >= 10 ? c.total : 0), 0), 0);
            const percentage = (passedUnits / totalUnits) * 100;
            document.getElementById('progressBar').style.width = `${percentage}%`;
            document.getElementById('passedUnits').textContent = passedUnits;
        }

        function exportData() {
            const data = { courses, terms, passedCourses };
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'student_data.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            const file = document.getElementById('importFile').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                const data = JSON.parse(e.target.result);
                courses = data.courses || defaultCourses;
                terms = data.terms || defaultTerms.map(t => ({ id: t, courses: [], totalUnits: 0, gpa: 0 }));
                passedCourses = data.passedCourses || [];
                saveData();
                renderCoursesTiles();
                calculateOverallGPA();
                updateProgress();
                showToast('داده‌ها با موفقیت وارد شدند.');
            };
            reader.readAsText(file);
        }

        function renderCalendar() {
            const calendarEl = document.getElementById('examCalendar');
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                events: terms.flatMap(term => term.courses.map(c => ({
                    title: c.name,
                    start: c.examTime,
                    allDay: false
                }))),
                locale: currentLanguage
            });
            calendar.render();
        }

        function checkExamReminders() {
            if (!('Notification' in window)) return;
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    terms.forEach(term => {
                        term.courses.forEach(c => {
                            const examDate = new Date(c.examTime.replace(/(\d{4})\/(\d{2})\/(\d{2}) (\d{2}:\d{2})/, '$1-$2-$3T$4'));
                            const now = new Date();
                            const oneDayBefore = new Date(examDate.getTime() - 24 * 60 * 60 * 1000);
                            if (now >= oneDayBefore && now < examDate) {
                                new Notification(`یادآور: امتحان ${c.name} در ${c.examTime}`);
                            }
                        });
                    });
                }
            });
        }

        function renderReports() {
            const ctxUnits = document.getElementById('unitsChart').getContext('2d');
            const types = ['عمومی', 'پایه', 'اصلی', 'اختیاری'];
            const unitsByType = types.map(type => courses.filter(c => c.type === type).reduce((sum, c) => sum + c.total, 0));
            new Chart(ctxUnits, {
                type: 'pie',
                data: { labels: types, datasets: [{ data: unitsByType, backgroundColor: ['#d4edda', '#d1ecf1', '#f8d7da', '#fff3cd'] }] },
                options: { plugins: { title: { display: true, text: translations[currentLanguage].unitsByType } } }
            });

            const ctxGPA = document.getElementById('gpaChart').getContext('2d');
            const termIds = terms.map(t => t.id);
            const gpas = terms.map(t => t.gpa);
            new Chart(ctxGPA, {
                type: 'line',
                data: { labels: termIds, datasets: [{ label: translations[currentLanguage].termGPA, data: gpas, borderColor: '#3498db', fill: false }] },
                options: { scales: { y: { beginAtZero: true, max: 20 } } }
            });

            const ctxGrades = document.getElementById('gradesChart').getContext('2d');
            const gradesByType = types.map(type => {
                const grades = terms.flatMap(t => t.courses.filter(c => c.type === type && c.grade >= 0).map(c => c.grade));
                return grades.length ? (grades.reduce((sum, g) => sum + g, 0) / grades.length).toFixed(2) : 0;
            });
            new Chart(ctxGrades, {
                type: 'bar',
                data: { labels: types, datasets: [{ label: translations[currentLanguage].avgGrade, data: gradesByType, backgroundColor: '#28a745' }] },
                options: { scales: { y: { beginAtZero: true, max: 20 } } }
            });
        }

        // حالت تاریک
        function toggleDarkMode() {
            const isDark = document.getElementById('darkModeToggle').checked;
            document.body.classList.toggle('dark-mode', isDark);
            localStorage.setItem('darkMode', isDark);
        }
        if (localStorage.getItem('darkMode') === 'true') {
            document.getElementById('darkModeToggle').checked = true;
            document.body.classList.add('dark-mode');
        }

        // آفلاین
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js');
        }

        // لود اولیه
        document.getElementById('languageToggle').value = currentLanguage;
        updateUIText();
        renderCoursesTiles();
        calculateOverallGPA();
        updateProgress();
        checkExamReminders();
    </script>
</body>
</html>