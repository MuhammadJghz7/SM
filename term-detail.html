<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>جزئیات ترم</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .weekly-schedule table {
      min-width: 700px;
    }
    @media (max-width: 768px) {
      .weekly-schedule {
        overflow-x: auto;
      }
      th, td {
        font-size: 0.8rem;
        padding: 5px;
      }
    }
    .cultural-time {
      background-color: #ffdddd;
      color: red;
      font-weight: bold;
    }
    td.busy {
      background-color: #d1e7dd;
    }
    td.conflict {
      background-color: #ff9999;
    }
  </style>
</head>
<body class="container py-4">

  <h1 class="mb-4">جزئیات ترم <span id="termId"></span></h1>

  <!-- فرم افزودن درس -->
  <div class="card mb-4">
    <div class="card-header">افزودن درس به ترم</div>
    <div class="card-body">
      <form id="addCourseForm">
        <div class="mb-3">
          <label for="courseSelect" class="form-label">انتخاب درس</label>
          <select id="courseSelect" class="form-select" required></select>
        </div>
        <div id="sessionsContainer"></div>
        <button type="submit" class="btn btn-primary">افزودن به ترم</button>
      </form>
    </div>
  </div>

  <!-- جدول هفتگی -->
  <h3 class="mb-3">برنامه هفتگی</h3>
  <div class="table-responsive weekly-schedule">
    <table class="table table-bordered text-center align-middle">
      <thead>
        <tr>
          <th>ساعت / روز</th>
          <th>شنبه</th>
          <th>یکشنبه</th>
          <th>دوشنبه</th>
          <th>سه‌شنبه</th>
          <th>چهارشنبه</th>
          <th>پنجشنبه</th>
        </tr>
      </thead>
      <tbody id="scheduleBody">
        <tr>
          <th>08:00 - 10:00</th>
          <td data-day="sat" data-time="08-10"></td>
          <td data-day="sun" data-time="08-10"></td>
          <td data-day="mon" data-time="08-10"></td>
          <td data-day="tue" data-time="08-10"></td>
          <td data-day="wed" data-time="08-10"></td>
          <td data-day="thu" data-time="08-10"></td>
        </tr>
        <tr>
          <th>10:00 - 12:00</th>
          <td data-day="sat" data-time="10-12"></td>
          <td data-day="sun" data-time="10-12"></td>
          <td class="cultural-time" data-day="mon" data-time="10-12">⛔</td>
          <td data-day="tue" data-time="10-12"></td>
          <td data-day="wed" data-time="10-12"></td>
          <td data-day="thu" data-time="10-12"></td>
        </tr>
        <tr>
          <th>13:00 - 15:00</th>
          <td data-day="sat" data-time="13-15"></td>
          <td data-day="sun" data-time="13-15"></td>
          <td data-day="mon" data-time="13-15"></td>
          <td data-day="tue" data-time="13-15"></td>
          <td data-day="wed" data-time="13-15"></td>
          <td data-day="thu" data-time="13-15"></td>
        </tr>
      </tbody>
    </table>
  </div>

  <script>
    const termId = new URLSearchParams(window.location.search).get('id');
    document.getElementById('termId').textContent = termId;

    let courses = JSON.parse(localStorage.getItem('courses')) || [];
    let terms = JSON.parse(localStorage.getItem('terms')) || [];

    const currentTerm = terms.find(t => t.id == termId);

    // پر کردن لیست دروس
    const courseSelect = document.getElementById('courseSelect');
    courses.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c.id;
      opt.textContent = `${c.name} (${c.id})`;
      courseSelect.appendChild(opt);
    });

    // وقتی یک درس انتخاب می‌شود، فیلدهای جلسات را ایجاد کن
    courseSelect.addEventListener('change', () => {
      const selectedCourse = courses.find(c => c.id == courseSelect.value);
      if (!selectedCourse) return;

      const totalSessions = calcSessions(selectedCourse);
      const container = document.getElementById('sessionsContainer');
      container.innerHTML = '';

      for (let i = 1; i <= totalSessions; i++) {
        const div = document.createElement('div');
        div.className = 'mb-3';
        div.innerHTML = `
          <label class="form-label">جلسه ${i}</label>
          <div class="row g-2">
            <div class="col-md-4">
              <select class="form-select day-select" required>
                <option value="">انتخاب روز</option>
                <option value="sat">شنبه</option>
                <option value="sun">یکشنبه</option>
                <option value="mon">دوشنبه</option>
                <option value="tue">سه‌شنبه</option>
                <option value="wed">چهارشنبه</option>
                <option value="thu">پنجشنبه</option>
              </select>
            </div>
            <div class="col-md-4">
              <select class="form-select time-select" required>
                <option value="">انتخاب ساعت</option>
                <option value="08-10">08:00 - 10:00</option>
                <option value="10-12">10:00 - 12:00</option>
                <option value="13-15">13:00 - 15:00</option>
              </select>
            </div>
            <div class="col-md-4">
              <input type="text" class="form-control place-input" placeholder="محل برگزاری" required>
            </div>
          </div>
        `;
        container.appendChild(div);
      }
    });

    // محاسبه تعداد جلسات بر اساس واحد
    function calcSessions(course) {
      let sessions = course.practicalUnits; // هر واحد عملی = یک جلسه
      if (course.theoreticalUnits >= 2) {
        sessions += Math.floor(course.theoreticalUnits / 2);
      }
      return sessions;
    }

    // پر کردن برنامه هفتگی از اطلاعات ترم
    function fillSchedule() {
      document.querySelectorAll('#scheduleBody td').forEach(td => {
        if (!td.classList.contains('cultural-time')) {
          td.innerHTML = '';
          td.classList.remove('busy', 'conflict');
        }
      });

      currentTerm.courses.forEach(c => {
        c.sessions.forEach(s => {
          const cell = document.querySelector(`[data-day="${s.day}"][data-time="${s.time}"]`);
          if (cell) {
            cell.innerHTML = `<strong>${c.name}</strong><br><small>${s.place}</small>`;
            cell.classList.add('busy');
          }
        });
      });
    }

    fillSchedule();

    // افزودن درس
    document.getElementById('addCourseForm').addEventListener('submit', e => {
      e.preventDefault();
      const selectedCourse = courses.find(c => c.id == courseSelect.value);
      const sessions = [];
      let conflict = false;

      document.querySelectorAll('#sessionsContainer .row').forEach(row => {
        const day = row.querySelector('.day-select').value;
        const time = row.querySelector('.time-select').value;
        const place = row.querySelector('.place-input').value;

        if (day === 'mon' && time === '10-12') {
          alert('این بازه زمانی ساعت فرهنگی است و نمی‌توان کلاس ثبت کرد.');
          conflict = true;
          return;
        }

        const cell = document.querySelector(`[data-day="${day}"][data-time="${time}"]`);
        if (cell && cell.innerHTML.trim() !== '') {
          cell.classList.add('conflict');
          alert('تداخل برنامه!');
          conflict = true;
          return;
        }

        sessions.push({ day, time, place });
      });

      if (conflict) return;

      currentTerm.courses.push({
        id: selectedCourse.id,
        name: selectedCourse.name,
        sessions
      });

      localStorage.setItem('terms', JSON.stringify(terms));
      fillSchedule();
      e.target.reset();
      document.getElementById('sessionsContainer').innerHTML = '';
    });
  </script>
</body>
</html>