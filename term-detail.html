<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>جزئیات ترم</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4">
  <div class="container">
    <a class="navbar-brand" href="index.html">مدیریت دروس من</a>
    <div>
      <a class="btn btn-outline-primary mx-1" href="index.html">داشبورد</a>
      <a class="btn btn-outline-primary mx-1" href="courses.html">ثبت دروس</a>
      <a class="btn btn-outline-primary mx-1" href="terms.html">فهرست ترم‌ها</a>
    </div>
  </div>
</nav>

<div class="container">
  <h3 class="mb-4">جزئیات ترم <span id="termIdDisplay"></span></h3>

  <button class="btn btn-success mb-3" id="addCourseToTermBtn">افزودن درس به ترم</button>

  <table class="table table-bordered table-striped">
    <thead>
      <tr>
        <th>شماره درس</th>
        <th>نام درس</th>
        <th>گروه</th>
        <th>جلسات</th>
        <th>زمان امتحان</th>
        <th>نمره</th>
        <th>وضعیت</th>
        <th>عملیات</th>
      </tr>
    </thead>
    <tbody id="termCoursesBody"></tbody>
  </table>
</div>

<!-- Modal افزودن درس -->
<div class="modal fade" id="addCourseModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <form id="addCourseForm">
        <div class="modal-header">
          <h5 class="modal-title">افزودن درس به ترم</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">

          <div class="mb-3">
            <label class="form-label">انتخاب درس</label>
            <select id="selectCourse" class="form-select" required></select>
          </div>

          <div class="mb-3">
            <label class="form-label">گروه درسی</label>
            <input type="text" id="groupNumber" class="form-control" required />
          </div>

          <div class="mb-3">
            <label class="form-label">تعداد جلسات کلاس</label>
            <input type="number" min="1" max="20" id="classSessions" class="form-control" value="1" required />
          </div>

          <div class="mb-3">
            <label class="form-label">جزئیات جلسات</label>
            <div id="sessionsContainer"></div>
          </div>

          <div class="mb-3">
            <label class="form-label">زمان امتحان</label>
            <input type="text" id="examTime" class="form-control" placeholder="مثلاً 1403/10/20 9:00" required />
          </div>

          <div class="mb-3">
            <label class="form-label">نمره (۰ تا ۲۰)</label>
            <input type="number" min="0" max="20" step="0.1" id="score" class="form-control" value="0" required />
          </div>

        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">ثبت</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
        </div>
      </form>
    </div>
  </div>
</div>

<footer class="mt-5 mb-3 text-center text-muted">
  ساخته شده توسط محمد
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="script.js"></script>
<script>
  const urlParams = new URLSearchParams(window.location.search);
  const termId = parseInt(urlParams.get("termId"), 10);
  document.getElementById("termIdDisplay").textContent = termId;

  let terms = getTerms();
  let courses = getCourses();
  let term = terms.find(t => t.id === termId);

  if (!term) {
    alert("ترم پیدا نشد!");
    window.location.href = "terms.html";
  }

  function renderTermCourses() {
    const tbody = document.getElementById("termCoursesBody");
    tbody.innerHTML = "";

    term.courses.forEach((tc, index) => {
      const course = courses.find(c => c.id === tc.courseId);
      if (!course) return;

      const passed = tc.score >= 10;
      const statusClass = passed ? "badge-passed" : "badge-failed";
      const statusText = passed ? "پاس شده" : "ناموفق";

      // نمایش جلسات
      const sessionsList = tc.sessions.map(s => `<li>${s.time} - ${s.location}</li>`).join("");

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${course.id}</td>
        <td>${course.name}</td>
        <td>${tc.groupNumber}</td>
        <td><ul>${sessionsList}</ul></td>
        <td>${tc.examTime}</td>
        <td><input type="number" min="0" max="20" step="0.1" class="form-control score-input" data-index="${index}" value="${tc.score}" /></td>
        <td><span class="badge ${statusClass}">${statusText}</span></td>
        <td><button class="btn btn-danger btn-sm btn-remove-course" data-index="${index}">حذف</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  document.getElementById("termCoursesBody").addEventListener("input", e => {
    if (e.target.classList.contains("score-input")) {
      const idx = parseInt(e.target.dataset.index, 10);
      let val = parseFloat(e.target.value);
      if (isNaN(val) || val < 0) val = 0;
      if (val > 20) val = 20;

      term.courses[idx].score = val;

      // اگر پاس شد → در لیست courses هم علامت بزن
      if (val >= 10) {
        let c = courses.find(x => x.id === term.courses[idx].courseId);
        if (c) c.passed = true;
        saveCourses(courses);
      }

      saveTerms(terms);
      renderTermCourses();
    }
  });

  document.getElementById("termCoursesBody").addEventListener("click", e => {
    if (e.target.classList.contains("btn-remove-course")) {
      const idx = parseInt(e.target.dataset.index, 10);
      if (confirm("حذف شود؟")) {
        term.courses.splice(idx, 1);
        saveTerms(terms);
        renderTermCourses();
      }
    }
  });

  const addCourseModal = new bootstrap.Modal(document.getElementById("addCourseModal"));
  document.getElementById("addCourseToTermBtn").addEventListener("click", () => {
    populateCourseSelect();
    createSessionFields(parseInt(document.getElementById("classSessions").value));
    document.getElementById("addCourseForm").reset();
    addCourseModal.show();
  });

  function populateCourseSelect() {
    const select = document.getElementById("selectCourse");
    select.innerHTML = "";

    const addedIds = term.courses.map(tc => tc.courseId);

    courses.forEach(c => {
      if (!addedIds.includes(c.id) && !c.passed) {
        const option = document.createElement("option");
        option.value = c.id;
        option.textContent = `${c.id} - ${c.name}`;
        select.appendChild(option);
      }
    });
  }

  const sessionsContainer = document.getElementById("sessionsContainer");
  const classSessionsInput = document.getElementById("classSessions");

  function createSessionFields(count) {
    sessionsContainer.innerHTML = "";
    for (let i = 1; i <= count; i++) {
      const div = document.createElement("div");
      div.classList.add("border", "p-2", "mb-2", "rounded");
      div.innerHTML = `
        <strong>جلسه ${i}</strong>
        <input type="text" name="sessionTime${i}" placeholder="زمان برگزاری" class="form-control mb-1" required />
        <input type="text" name="sessionLocation${i}" placeholder="محل برگزاری" class="form-control" required />
      `;
      sessionsContainer.appendChild(div);
    }
  }

  classSessionsInput.addEventListener("input", e => {
    let val = parseInt(e.target.value);
    if (isNaN(val) || val < 1) val = 1;
    if (val > 20) val = 20;
    createSessionFields(val);
  });

  document.getElementById("addCourseForm").addEventListener("submit", e => {
    e.preventDefault();

    const courseId = document.getElementById("selectCourse").value;
    const groupNumber = document.getElementById("groupNumber").value.trim();
    const classSessions = parseInt(classSessionsInput.value);
    const examTime = document.getElementById("examTime").value.trim();
    const score = parseFloat(document.getElementById("score").value);

    const course = courses.find(c => c.id === courseId);
    if (!course) {
      alert("درس انتخابی نامعتبر است");
      return;
    }

    // جمع‌آوری جلسات
    const sessions = [];
    for (let i = 1; i <= classSessions; i++) {
      const time = document.querySelector(`[name=sessionTime${i}]`).value.trim();
      const location = document.querySelector(`[name=sessionLocation${i}]`).value.trim();
      sessions.push({ time, location });
    }

    term.courses.push({
      courseId,
      groupNumber,
      classSessions,
      sessions,
      examTime,
      score
    });

    saveTerms(terms);
    renderTermCourses();
    addCourseModal.hide();
  });

  renderTermCourses();
</script>

</body>
</html>